# php-deploy-receiver

共有レンタルサーバーへのデプロイが思った以上にめんどい。

* SSHが使えない
* FTPしか開いていない
  * そんでもって海外IPアドレスからのアクセスが閉じられている
* CIでnpmぶん回したりして成果物はあるのにアップロードできない

そんな状況なのでPHP稼働OKなサーバーで自動デプロイしたいのにできない。

本ソフトウェアはこれを何とか回避したい。

1. レンタルサーバーにモジュール・設定を配置（手動）
2. CDのタイミングで配置モジュールに成果物を転送
3. 転送後に配置モジュールへデプロイを指示
4. でぷろいー

これが出来ればすっごいうれしい。

要件は以下。

1. PHPが稼働すること
2. ファイルを結合できること
3. ZIPファイルを展開できること
4. デプロイ後にマイグレーション等の処理を走らせるための追加スクリプト実行

考えてるフローとしては、

1. 初回セットアップとしてモジュール配置と設定は必須
   1. 暗号キーを設定
   2. Webページを配置するパスの絶対パスを設定。これはCI側でも用いる
   3. モジュールディレクトリの相対パスを設定(2.で設定したパスからの相対パス)
2. モジュールアクセスには暗号化した文を用いる（レンタルサーバーってTLS使えないとこ多数）
   1. 復号失敗の場合は404でよい
   2. 復号化した後のデータはフラットなJSONで単純にKEY=VALUEでアクセス
   3. ファイルはめんどいけどbase64かなぁ。。。
3. デプロイ準備要求
   1. 不要ファイルを破棄してログデータを構築
   2. トークンを発行し、後続処理はトークンを一緒に送り、トークンがないとか誤ってる場合は404
4. ファイル送信処理を実施
   1. CD側で頑張るしかないけど`split`かなんかで分け分けして送る
   2. サーバー側が10MBの転送を許してないかもしれないのでこの工程は必要
5. ファイル連携完了処理を実施
   1. ファイルのハッシュも一緒に送る
   2. 転送されたファイル一式をまとめてハッシュ算出、突合
   3. ファイルを作業ディレクトリ以下に展開
6. デプロイ処理
   1. 複雑になる・設定ファイルの保持がつらいので差分アップデートやミラーリング的な処理は一切行わない
   2. メンテ用 index.html 的なのを作ってルート `.htaccess` を書き換える
      1. メンテ用 index.html に全アクセスさせる
      2. この際、CSS/JSや画像も全て メンテ用 index.html に寄せる
   3. 前処理スクリプトがあれば実施
   4. 作業ディレクトリ以下のファイルを公開ディレクトリに全て移送する
      1. こうすることで本モジュールも更新対象になる
      2. `.htaccess` のみ配置対象外とし、内部的にリストアップ
   5. 後処理スクリプトがあれば実施
   6. リストアップした `.htaccess` を移送
   7. トークン保存データを破棄
